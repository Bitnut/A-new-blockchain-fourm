{"version":3,"sources":["../../src/server/prod_logger.js"],"names":["humanize","require","bytes","module","exports","prod_logger","logger","next","start","Date","asset","originalUrl","indexOf","console","log","method","session","uid","length","response","ctx","len","err","status","upstream","time","delta","Math","round"],"mappings":";;;;;;;;AAAA,IAAIA,WAAWC,QAAQ,iBAAR,CAAf;AACA,IAAIC,QAAQD,QAAQ,OAAR,CAAZ;;AAEAE,OAAOC,OAAP,GAAiBC,WAAjB;;AAEA,SAASA,WAAT,GAAuB;AACnB,oDAAO,SAAUC,MAAV,CAAiBC,IAAjB;AAAA;AAAA;AAAA;AAAA;AAAA;AACH;AACIC,iCAFD,GAES,IAAIC,IAAJ,EAFT;AAGCC,iCAHD,GAIC,KAAKC,WAAL,CAAiBC,OAAjB,CAAyB,UAAzB,MAAyC,CAAzC,IACA,KAAKD,WAAL,CAAiBC,OAAjB,CAAyB,UAAzB,MAAyC,CADzC,IAEA,KAAKD,WAAL,CAAiBC,OAAjB,CAAyB,cAAzB,MAA6C,CAN9C;;AAOH,gCAAI,CAACF,KAAL,EACIG,QAAQC,GAAR,CACI,WACI,KAAKC,MADT,GAEI,GAFJ,GAGI,KAAKJ,WAHT,GAII,GAJJ,IAKK,KAAKK,OAAL,CAAaC,GAAb,IAAoB,EALzB,CADJ;AARD;AAAA;AAAA,mCAiBOV,IAjBP;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAmBCO,gCAAI,IAAJ,EAAUN,KAAV,EAAiB,IAAjB,eAA4B,KAA5B;AAnBD;;AAAA;AAsBCU,kCAtBD,GAsBU,KAAKC,QAAL,CAAcD,MAtBxB;;AAuBHJ,gCAAI,IAAJ,EAAUN,KAAV,EAAiBU,MAAjB,EAAyB,IAAzB,EAA+BR,KAA/B;;AAvBG;AAAA;AAAA;AAAA;AAAA;AAAA,eAAUJ,MAAV;AAAA,SAAP;AAAA;AAyBH;;AAED,SAASQ,GAAT,CAAaM,GAAb,EAAkBZ,KAAlB,EAAyBa,GAAzB,EAA8BC,GAA9B,EAAmCZ,KAAnC,EAA0C;AACtC,QAAIa,SAASD,MAAMA,IAAIC,MAAJ,IAAc,GAApB,GAA0BH,IAAIG,MAAJ,IAAc,GAArD;;AAEA,QAAIL,MAAJ;AACA,QAAI,CAAC,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,EAAgBN,OAAhB,CAAwBW,MAAxB,CAAL,EAAsC;AAClCL,iBAAS,EAAT;AACH,KAFD,MAEO,IAAI,QAAQG,GAAZ,EAAiB;AACpBH,iBAAS,GAAT;AACH,KAFM,MAEA;AACHA,iBAAShB,MAAMmB,GAAN,CAAT;AACH;;AAED,QAAIG,WAAWF,MAAM,KAAN,GAAc,KAA7B;;AAEA,QAAI,CAACZ,KAAD,IAAUY,GAAV,IAAiBF,IAAIG,MAAJ,GAAa,GAAlC,EACIV,QAAQC,GAAR,CACI,OAAOU,QAAP,GAAkB,oBADtB,EAEIJ,IAAIL,MAFR,EAGIK,IAAIT,WAHR,EAIIY,MAJJ,EAKIE,KAAKjB,KAAL,CALJ,EAMIU,MANJ,EAOIE,IAAIJ,OAAJ,CAAYC,GAAZ,IAAmB,EAPvB;AASP;;AAED,SAASQ,IAAT,CAAcjB,KAAd,EAAqB;AACjB,QAAIkB,QAAQ,IAAIjB,IAAJ,KAAaD,KAAzB;AACAkB,YAAQA,QAAQ,KAAR,GAAgBA,QAAQ,IAAxB,GAA+BC,KAAKC,KAAL,CAAWF,QAAQ,IAAnB,IAA2B,GAAlE;AACA,WAAO1B,SAAS0B,KAAT,CAAP;AACH","file":"prod_logger.js","sourcesContent":["var humanize = require('humanize-number');\nvar bytes = require('bytes');\n\nmodule.exports = prod_logger;\n\nfunction prod_logger() {\n    return function* logger(next) {\n        // request\n        var start = new Date();\n        var asset =\n            this.originalUrl.indexOf('/assets/') === 0 ||\n            this.originalUrl.indexOf('/images/') === 0 ||\n            this.originalUrl.indexOf('/favicon.ico') === 0;\n        if (!asset)\n            console.log(\n                '  <-- ' +\n                    this.method +\n                    ' ' +\n                    this.originalUrl +\n                    ' ' +\n                    (this.session.uid || '')\n            );\n        try {\n            yield next;\n        } catch (err) {\n            log(this, start, null, err, false);\n            throw err;\n        }\n        var length = this.response.length;\n        log(this, start, length, null, asset);\n    };\n}\n\nfunction log(ctx, start, len, err, asset) {\n    var status = err ? err.status || 500 : ctx.status || 404;\n\n    var length;\n    if (~[204, 205, 304].indexOf(status)) {\n        length = '';\n    } else if (null == len) {\n        length = '-';\n    } else {\n        length = bytes(len);\n    }\n\n    var upstream = err ? 'xxx' : '-->';\n\n    if (!asset || err || ctx.status > 400)\n        console.log(\n            '  ' + upstream + ' %s %s %s %s %s %s',\n            ctx.method,\n            ctx.originalUrl,\n            status,\n            time(start),\n            length,\n            ctx.session.uid || ''\n        );\n}\n\nfunction time(start) {\n    var delta = new Date() - start;\n    delta = delta < 10000 ? delta + 'ms' : Math.round(delta / 1000) + 's';\n    return humanize(delta);\n}\n"]}